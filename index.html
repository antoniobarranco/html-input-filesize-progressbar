<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<!-- We are using Bootstrap (it workks on any moderne version) but you can adapt the code to any other CSS framework.  -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

<body>

    <div class="head my-3">

        <div class="container">
            <div class="row">
                <div class="col">
                    <h1>Html input filesize progressbar - Code example </h1>
                    <p>Vanilla JS to implement Bootstrap based progressbar to indicate file size quota on frontend,
                        supporting
                        both multiple file inputs and single file inputs with 'multiple' atribute.</p>
                </div>
            </div>
        </div>

    </div>

    <div class="main">

        <div class="container">
            <div class="row">

                <div class="col">

                    <div class="card my-3">
                        <div class="card-header">Total attached</div>
                        <div class="card-body">
                            <p>Total size of files attached may not exceed the maximum allowed size. </p>


                            <!-- BEGIN Bootstrap Progressbar -->
                            <!-- This is the important part of the code, that represents the initial state of progressbar -->

                            <div class="progress my-4">
                                <div id="fileSizeIndicator" class="progress-bar" role="progressbar" aria-valuenow="70"
                                    aria-valuemin="0" aria-valuemax="100" title="0%" style="width:0%; min-width: 2em;"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="0%">
                                    <span id="fileSizeIndicatorLabel">0%</span>
                                </div>
                            </div>

                            <!-- Some help to our users to downsize their files if needed -->

                            <div class="alert alert-primary" id="fileSizeAlertInfo" role="alert"
                                style="display: none;">
                                Did you know that you can reduce the size of a PDF file or image using totally free
                                cloud-based
                                tools such as <a href="#" target="_blank">'your favorite tool'</a>?
                            </div>


                            <!-- END Bootstrap Progressbar -->

                        </div>
                        <div class="card-footer">Max allowed: 10 MB</div>
                    </div>

                    <!-- Form: It allows any type of form with file type inputs -->
                    <form class="my-5">
                        <div class="mb-3">
                            <label for="inputFile01" class="form-label">Input file 1 - Single file</label>
                            <input type="file" class="form-control fileupload" id="inputFile01" aria-describedby="inputFileHelp01">
                            <div id="inputFileHelp01" class="form-text">Standard file input that allows only one file
                                selection.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="inputFile01" class="form-label">Input file 2 - Single file</label>
                            <input type="file" class="form-control fileupload" id="inputFile01" aria-describedby="inputFileHelp02">
                            <div id="inputFileHelp02" class="form-text">Standard file input that allows only one file
                                selection.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="inputFile01" class="form-label">Input file 3 - Multiple files</label>
                            <input type="file" class="form-control fileupload" id="inputFile01" aria-describedby="inputFileHelp03">
                            <div id="inputFileHelp03" class="form-text">Standard file input that allows
                                <strong>multiple</strong> file
                                selection.
                            </div>
                        </div>
                        <div class="alert alert-primary my-4">
                            Don't worry: Any file is uploaded on this example, try it easy :)
                        </div>

                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>

                </div>

            </div>
        </div>
    </div>


</body>

<script>
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';

        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function checkTotalFilesize() {
        let fileSize = 0;
        let fileuploadcollection = document.getElementsByClassName("fileupload");
        for (let item of fileuploadcollection) {
            for (let file of item.files) {
                fileSize += file.size;
            }
        }
        return fileSize;
    }

    function updateProgressBar(currentSize, maxSize = 25165824) {

        let currentPercent = ((currentSize * 100) / maxSize).toFixed();

        if (currentPercent <= 100) {
            document.getElementById("fileSizeIndicator").setAttribute("aria-valuenow", currentSize);
            document.getElementById("fileSizeIndicator").setAttribute("aria-valuemax", "100%");
            document.getElementById("fileSizeIndicator").style.width = currentPercent + "%";
            document.getElementById("fileSizeIndicatorLabel").textContent = currentPercent + "% - " + formatBytes(
                currentSize);
            document.getElementById("fileSizeIndicator").setAttribute("title", currentPercent + "% - " + formatBytes(
                currentSize));
            document.getElementById("fileSizeIndicator").className = "progress-bar progress-bar-success";
            document.getElementById("fileSizeAlertInfo").style.display = "none";
        } else {
            document.getElementById("fileSizeIndicator").setAttribute("aria-valuenow", currentSize);
            document.getElementById("fileSizeIndicator").setAttribute("aria-valuemax", "100%");
            document.getElementById("fileSizeIndicator").style.width = "100%";
            document.getElementById("fileSizeIndicatorLabel").textContent = formatBytes(currentSize) +
                " Error: El tamaño total de los ficheros supera el límite";
            document.getElementById("fileSizeIndicator").setAttribute("title", formatBytes(currentSize) +
                " Error: El tamaño total de los ficheros supera el límite");
            document.getElementById("fileSizeIndicator").className = "progress-bar progress-bar-danger";

            document.getElementById("fileSizeAlertInfo").style.display = "block";

        }

    }

    // Get all file inputs and set the proper event handler

    const InputFileUploaders = document.getElementsByClassName("fileupload");

    for (let item of InputFileUploaders) {
        item.addEventListener('input', event => {
            updateProgressBar(checkTotalFilesize());
        });
    }

</script>

</html>
